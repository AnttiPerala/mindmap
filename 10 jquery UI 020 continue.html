<!DOCTYPE html>
<html lang="en">
   <head>
      <meta charset="UTF-8">
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>Document</title>
      <style>

         body{
         background-color: azure !important;
         height: 100%;
         margin: 0;
         }

         #mainArea {
         min-height: 90vh;
         min-width: 100vw;
         z-index: 20;
         position: absolute;
         }

         .circle{
         width: 120px;
         height: 120px;
         background: crimson;
         margin: 1rem;
         border-radius: 50%;
         display: inline-flex;
         align-items: center;
         justify-content: center;
         position: absolute;
         z-index: initial;
         user-select:none;
         box-sizing: border-box;
         }

         .selected{
         border: 5px solid #B9A44C;
         }

         .plus{
         font-size: 5rem;
         font-weight: bolder;
         display: inline-block;
         background-color: crimson;
         width: 4rem;
         height: 4rem;
         text-align: center;
         display: inline-flex;
         align-items: center;
         justify-content: center;
         }

         .circle input{
         width: 95%;
         z-index: 10;
         position: relative;
         background: crimson;
        color: white;
        border: none;
        text-align: center;
         }

         div.line {
         transform-origin: 0 100%;
         height: 3px;
         background: rgb(44, 44, 44);
         }

         #header{
             display: flex;
             align-items: center;
             justify-content: space-evenly;
             background-color: rgb(44, 44, 44);
             padding: 2rem;
         }

         #instructions{
            color: cadetblue; 
         }

         #siteTitle{
            color: rgb(255, 255, 255);
            font-size: 2rem;
         }


         input::placeholder { /* Chrome, Firefox, Opera, Safari 10.1+ */
  color: rgb(75, 54, 54);
  opacity: 1; /* Firefox */
}

      </style>
   </head>
   <body>
      <div id="header">
          <div id="siteTitle">MindMapper</div>
         <div class="plus">+</div>
         <div id="instructions">Shift + click on a circle to add a connecting line.</div>
      </div>
      <div id="mainArea">
         <div id="id0" class="circle selected"><input type="text" placeholder="Type something"></input></div>
      </div>
      <script src="jquery-3.6.0.min.js"></script>
      <script src="jquery-ui.min.js"></script>
      <script>
          
         let newCircleId = 1;
         let moveLineId = "moveLine";
         
   
         $('.circle').draggable({
            drag: function(event, ui) {
            console.log('dragging');
            updateLines(this);
            }
        });
         
         //create circles:
         
         $('.plus').on('click', function(){
         
             let circleHTML = `<input type="text" placeholder="Type something"></input>`;
         
             $('.circle').removeClass('selected');
             
             $('<div class="circle selected"><input type="text" placeholder="Type something"></input></div>')
             .prependTo('#mainArea')
             .draggable({
                drag: function(event, ui) {
                console.log('dragging');
                updateLines(this);
                }
            })
             .attr('id','id'+newCircleId);
         
             newCircleId++;
         
             //console.log('clicked plus');
         
         
         })
         
         //select circles
         
         
         $('body').on('mousedown', '.circle', function(){
             console.log('click');
             if (!event.shiftKey) { //not holding shift
                $('.circle').removeClass('selected');
                $(this).addClass('selected');
             }
             
             
         });
         
         
         //detect shift click:

            $('body').on('mouseup', '.circle', function(event){
            if (event.shiftKey) {
                console.log('shift click');
                let selectedCircle = $('.selected');
                
                createLine(selectedCircle.offset().left+selectedCircle.width()/2, selectedCircle.offset().top+selectedCircle.height()/2, $(this).offset().left+$(this).width()/2, $(this).offset().top+$(this).height()/2, selectedCircle.attr('id'), $(this).attr('id'));
                
            }
        })
         
         
         function createLine(x1, y1, x2, y2, circle1, circle2) {
         
         console.log('called create line. x1: ' + x1 + ' y1: ' + y1 + ' x2: ' + x2 + ' y2: ' + y2 );
         //$( '.circle' ).draggable( 'option',  'revert', false ).trigger( 'mouseup' );
         
         
         var length = Math.sqrt(((x1 - x2) * (x1 - x2)) + ((y1 - y2) * (y1 - y2)));
         var angle = Math.atan2(y2 - y1, x2 - x1) * 180 / Math.PI;
         var transform = 'rotate(' + angle + 'deg)';
         
         offsetX = (x1 > x2) ? x2 : x1;
         offsetY = (y1 > y2) ? y2 : y1;
         
         var line = $('<div>')
         .appendTo('#mainArea')
         .addClass('line')
         .css({
         'position': 'absolute',
         '-webkit-transform': transform,
         '-moz-transform': transform,
         'transform': transform
         })
         .width(length)
         .offset({
         left: offsetX,
         top: offsetY
         })
         .attr("data-circle1", circle1)
         .attr("data-circle2", circle2)
         
         ;
 
         return line;
         }


        

         //move a draggable with a line connected to it

         let allConnectedLines;

         function updateLines(element){

            //console.log('updateLines here, with element: ' + element);
            //let connectedLines = $(".line[data-circle1=" + element.id + "]", ".line[data-circle2=" + element.id + "]");

           /*  let connectedLines1 = $('.line').data('circle1', element.id);
            let connectedLines2 = $('.line').data('circle2', element.id);
            allConnectedLines = $.merge(connectedLines1, connectedLines2); */

            let allConnectedLines = $('.line[data-circle1="' + element.id +'"],.line[data-circle2="'+ element.id +'"]');

            console.log('element id is ' + element.id + ' allConnectedLines length: ' + allConnectedLines.length);


            //for redrawing them we need to loop through all the selected lines and for each of them we will get the two data attributes, then select two circles based on those attributes and get the coordinates of those circles for redrawing
            //finally we destroy the old connected lines

            allConnectedLines.each(function(i,e){

                let lineCircleConnect1 = $(e).data('circle1');
                let lineCircleConnect2 = $(e).data('circle2');

                console.log('lineCircleConnect1: ' + lineCircleConnect1 +' lineCircleConnect2: '+ lineCircleConnect2);

                let circle1 = $('#' + lineCircleConnect1);
                let circle2 = $('#' + lineCircleConnect2);

                $(this).remove();

                createLine(circle1.offset().left+circle1.width()/2, circle1.offset().top+circle1.height()/2, circle2.offset().left+circle2.width()/2,circle2.offset().top+circle2.height()/2, circle1.attr('id'), circle2.attr('id'));

            })



            //console.log(connectedLines);

            

         }
 
         //circle settings
         
          
         
         
         
         //save to local storage
         
         
         
         

      </script>
   </body>
</html>